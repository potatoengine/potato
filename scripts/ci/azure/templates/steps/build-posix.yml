parameters:
  configuration: RelWithDebInfo
  cxx_compiler: g++-7

steps:
- bash: |
    set -xe

    build_dir="build/${{parameters.configuration}}-${{parameters.cxx_compiler}}"

    mkdir -p "${build_dir}"
    cd "${build_dir}"

    CXXFLAGS="-Wall -Werror"

    cmake "-DCMAKE_CXX_COMPILER=${{parameters.cxx_compiler}}" -DBUILD_SHARED_LIBS=OFF "-DCMAKE_BUILD_TYPE:STRING=${{parameters.configuration}}" -DFETCHCONTENT_BASE_DIR=_deps ../..

    cmake --build . --parallel

    ctest -R potato --verbose
  displayName: Build (${{parameters.configuration}} ${{parameters.cxx_compiler}})
- task: PublishTestResults@2
  inputs:
    testResultsFormat: cTest
    searchFolder: build
