parameters:
  build_shared: Shared
  configuration: RelWithDebInfo

steps:
- script: |
    echo on
    setlocal enableextensions enabledelayedexpansion

    set VCDIR=C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise
    set ROOT=%BUILD_SOURCESDIRECTORY%
    set CONFIG=${{parameters.configuration}}
    if ${{parameters.build_shared}} EQU Share (set SHARED=ON) else (set SHARED=OFF)
    set BUILDDIR=%ROOT%/build/%CONFIG%-${{parameters.build_shared}}

    set PATH=%PATH%;%ROOT%\bin

    call "%VCDIR%\VC\Auxiliary\Build\vcvarsall.bat" x64
    echo

    set CC=cl.exe
    set CXX=cl.exe

    set CXXFLAGS=/W3 /WX

    mkdir "%BUILDDIR%"
    cd "%BUILDDIR%"

    rem configure
    cmake -G Ninja -DCMAKE_BUILD_TYPE:STRING=%CONFIG% -DSDL2_PATH:PATH="%ROOT%/deps/SDL2-2.0.9" -DBUILD_SHARED_LIBS=%SHARED% -DASSIMP_ROOT_DIR:PATH="%ROOT%/deps/assimp-4.1.0" -DFETCHCONTENT_BASE_DIR=_deps "%ROOT%" || exit /b 1

    rem build
    cmake --build . --parallel || exit /b 1

    rem run tests
    ctest -R potato --verbose || exit /b 1
  displayName: Build (${{parameters.configuration}} ${{parameters.build_shared}})
